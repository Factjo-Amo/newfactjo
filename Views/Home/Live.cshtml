@{
    ViewData["Title"] = "البث المباشر";
}

<div class="container my-5">
    <h2 class="text-danger text-center mb-4">📺 البث المباشر الآن</h2>

    <div class="row justify-content-center">
        <!-- ✅ الشات على اليسار -->
        <div class="col-md-5 order-md-1 order-2">
            <div class="border rounded-3 p-3 shadow-sm" style="background-color: #f8f9fa; min-height: 380px;">
                <!-- ✅ إدخال اسم المستخدم أول مرة -->
                <div id="usernamePrompt" class="mb-3">
                    <label class="form-label fw-bold">👤 أدخل اسمك لبدء المحادثة:</label>
                    <div class="input-group">
                        <input type="text" id="usernameInput" class="form-control" placeholder="مثلاً: أحمد">
                        <button onclick="saveUsername()" class="btn btn-outline-primary">حفظ</button>
                    </div>
                </div>

                <!--الشات -->
                <h5 class="mb-3 text-primary fw-bold">💬 دردشة المشاهدين</h5>

                <!-- ✅ حقل كتابة الرسالة -->
                <div class="mb-2">
                    <textarea id="messageInput" class="form-control border border-secondary shadow-sm" rows="3"
                              placeholder="اكتب رسالتك هنا..." style="background-color: #ffffff;"></textarea>
                    <button type="button" id="emojiBtn"
                            class="btn btn-light position-absolute"
                            style="bottom: 5px; left: 5px;">
                        😊
                    </button>

                </div>

                <!-- ✅ زر الإرسال ورفع صورة -->
                <div class="d-flex justify-content-between align-items-center">
                    <input type="file" class="form-control form-control-sm w-50 border border-secondary" />
                    <button id="sendBtn" class="btn btn-danger btn-sm ms-2">إرسال</button>
                </div>

                <!-- ✅ الرسائل -->
                <div id="messages" class="mt-4 pt-3 px-2" style="max-height: 200px; overflow-y: auto;">
                    @if (ViewBag.ChatMessages != null)
                    {
                        foreach (var msg in (List<Newfactjo.Models.ChatMessage>)ViewBag.ChatMessages)
                        {
                            var isMe = msg.User == "مشاهد";
                            @* يمكن تغييره لاحقًا حسب اسم المستخدم الفعلي *@

                            <div class="d-flex @(isMe ? "justify-content-end" : "justify-content-start")">
                                <div class="mb-2 p-2 rounded shadow-sm"
                                     style="max-width: 70%; background-color: @(isMe ? "#d1f2eb" : "#f0f0f0");">
                                    <div class="small text-muted mb-1">@msg.User</div>
                                    <div class="fw-semibold">@msg.Message</div>
                                </div>
                            </div>
                        }

                    }
                </div>

            </div>
        </div>


        <!-- ✅ الفيديو على اليمين -->
        <div class="col-md-7 order-md-2 order-1 mb-3 mb-md-0">
            <div class="shadow-lg border border-3 border-danger rounded-4 overflow-hidden"
                 style="padding: 5px; background-color: #000;">
                <div class="ratio ratio-16x9 rounded">
                    <iframe src="https://ghaasiflu.online/alhqeqa/embed.html"
                            allowfullscreen
                            frameborder="0"
                            width="100%"
                            height="100%">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
    <audio id="notificationSound" src="/sounds/ding.mp3" preload="auto"></audio>

</div>



@section Scripts {
    <!-- ✅ تحميل مكتبة PicMo الأساسية -->
    <!-- ✅ ربط مكتبة PicMo محليًا -->
    <script src="~/lib/picmo/picmo.umd.js"></script>
    <script src="~/lib/picmo/popup-picker.umd.js"></script>



      <!-- ✅ مكتبة SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        connection.start().then(() => {
            console.log("✅ تم الاتصال بـ SignalR");
        }).catch(err => console.error("❌ فشل الاتصال:", err.toString()));

        // ✅ عند استلام رسالة
        connection.on("ReceiveMessage", function (user, message, timestamp) {
            const wrapper = document.createElement("div");
            const currentUser = localStorage.getItem("chatUsername") || "مشاهد";

            wrapper.className = (user === currentUser)
                ? "d-flex justify-content-end"
                : "d-flex justify-content-start";

            // ✅ تنسيق الوقت
            const timeFormatted = new Date(timestamp).toLocaleTimeString('ar-JO', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const msgDiv = document.createElement("div");
            msgDiv.className = "mb-2 p-2 rounded shadow-sm";
            msgDiv.style.maxWidth = "70%";
            msgDiv.style.backgroundColor = (user === currentUser) ? "#d1f2eb" : "#f0f0f0";

            msgDiv.innerHTML = `
                <div class="small text-muted mb-1">🕒 ${timeFormatted} - <strong>${user}</strong></div>
                <div class="fw-semibold">${message}</div>
            `;

            wrapper.appendChild(msgDiv);
            document.getElementById("messages").appendChild(wrapper);

            // ✅ صوت التنبيه
            document.getElementById("notificationSound").play().catch(e => {
                console.warn("🔇 لم يتم تشغيل الصوت تلقائيًا");
            });
        });

        // ✅ إرسال الرسالة
        document.getElementById("sendBtn").addEventListener("click", function (event) {
            event.preventDefault();

            const user = localStorage.getItem("chatUsername") || "مشاهد";
            const message = document.getElementById("messageInput").value.trim();

            if (!user) {
                alert("الرجاء إدخال اسمك أولاً.");
                return;
            }

            if (message !== "") {
                connection.invoke("SendMessage", user, message)
                    .catch(err => console.error(err.toString()));
                document.getElementById("messageInput").value = "";
            }
        });

        // ✅ تفعيل مكتبة PicMo
        const trigger = document.querySelector('#emojiBtn');
        const messageInput = document.querySelector('#messageInput');

        const picker = Picmo.createPopup({}, {
            triggerElement: trigger,
            referenceElement: trigger,
            position: 'top-start'
        });

        picker.addEventListener('emoji:select', event => {
            messageInput.value += event.emoji;
        });

        // ✅ حفظ الاسم في LocalStorage
        function saveUsername() {
            const name = document.getElementById("usernameInput").value.trim();
            if (name !== "") {
                localStorage.setItem("chatUsername", name);
                document.getElementById("usernamePrompt").style.display = "none";
            }
        }

        // ✅ إخفاء نموذج الاسم إذا كان محفوظ
        window.onload = function () {
            if (localStorage.getItem("chatUsername")) {
                document.getElementById("usernamePrompt").style.display = "none";
            }
        }
    </script>
}
