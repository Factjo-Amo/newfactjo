
@model Newfactjo.ViewModels.HomeIndexViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["FullWidth"] = "container-fluid";
}

@{
    ViewData["Title"] = Localizer["HomePageTitle"];

    var newsList = Model.LatestNews;
    var articleList = Model.LatestArticles;
    var tickerNews = Model.TickerNews;
    var categoriesWithNews = Model.CategoriesWithNews
        .Where(c => c.CategoryId != 1)
        .ToList();
}

@{
    var panoramaNews = ViewBag.PanoramaNews as List<Newfactjo.Models.News>;
}

<!-- شريط الفلاش لاين -->
@await Component.InvokeAsync("FlashLine", new { take = 8, categoryId = 11 })
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env
@if (Env.IsDevelopment())   // إن لم تكن البيئة Development احذف هذا السطر وهذا القوس السفلي مؤقتًا
{
    var dn = ViewBag.DowntownNews as List<Newfactjo.Models.News>;
    var pn = ViewBag.PanoramaNews as List<Newfactjo.Models.News>;
  @*  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:6px;margin:8px 0;border-radius:6px;font-size:.9rem">
       <b>DEBUG COUNTS</b> —
        DowntownNews: @(dn == null ? "null" : dn.Count.ToString()) |
        SpecialThreeColumns: @(Model?.SpecialThreeColumns?.Count() ?? 0) |
        Panorama: @(pn == null ? "null" : pn.Count.ToString()) |
        Ads: @(Model?.Advertisements?.Count() ?? 0)
    </div> *@
}


<div class="container mb-0" style="border: 2px solid white;">
    <!-- خط أحمر فاصل -->
    <div class="divider-red"></div>

    <div class="row strip-row g-2">
        <!-- ✅ الخبر الرئيسي (أقل من النصف على الشاشات الكبيرة) -->
        <div class="col-12 col-md-6 col-lg-5 d-flex ">
            @{
                var mainNews = Model.MainTopNews;
            }
            @if (mainNews != null)
            {
                <a asp-controller="News" asp-action="Details" asp-route-id="@mainNews.Id"
                   class="text-decoration-none text-white w-100 h-100">
                    <div class="card-clean bg-dark w-100 h-100">
                        <div class="ratio-main">
                            <img src="@(!string.IsNullOrEmpty(mainNews.ImageUrl) ? mainNews.ImageUrl : "/images/default.jpg")"
                                 alt="@mainNews.Title" title="@mainNews.Title" fetchpriority="high" decoding="async" width="1200" height="675"
                                 sizes="(max-width: 991.98px) 100vw, 45vw" />
                        </div>
                        <div class="news-overlay">
                            <h3 class="news-title news-title--main">@mainNews.Title</h3>
                        </div>
                    </div>
                </a>
            }
        </div>

        <!-- ✅ الأخبار المصغّرة (6 عناصر تملأ بقية الشريط) -->
        <div class="col-12 col-md-6 col-lg-7">
            <div class="small-grid">
                @foreach (var news in Model.MainSmallNews?.Take(4) ?? Enumerable.Empty<Newfactjo.Models.News>())
                {
                    <a asp-controller="News" asp-action="Details" asp-route-id="@news.Id"
                       class="text-decoration-none text-white">
                        <div class="card-clean bg-dark">
                            <div class="ratio-tiles">
                                <img src="@(!string.IsNullOrEmpty(news.ImageUrl) ? news.ImageUrl : "/images/default.jpg")"
                                     alt="@news.Title" title="@news.Title" loading="lazy" decoding="async" width="800" height="500"
                                     sizes="(max-width: 575.98px) 100vw, (max-width: 991.98px) 50vw, 22vw" />
                            </div>
                            <div class="news-overlay">
                                <h3 class="news-title">@news.Title</h3>
                            </div>
                        </div>
                    </a>
                }
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/index-home.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/_TopBarNews.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/flashline.css" asp-append-version="true" />
    @* ملف CSS للتحكم بشكل شريط الفلاشلاين *@
}

<div class="container-fluid px-0">
    <div class="row">
        <div class="d-none d-md-block col-md-2"></div>
        <div class="col-12">

            <!-- ✅ شريط الاخبار المصورة اعلى الموقع -->
            @{
                var downtownNews = ViewBag.DowntownNews as List<Newfactjo.Models.News> ?? new List<Newfactjo.Models.News>();
            }
            <section class="my-0">
                @await Html.PartialAsync("_TopStoriesJsonLd", Model)

                <!-- ✅ خط أحمر فاصل -->
                <div style="height: 3px; background-color: #9b040c; margin: 10px 0;"></div>

                <div class="row g-3">
                    <!-- العمود الأول: خبران بنفس الارتفاع -->
                    <div class="col-md-4 d-flex flex-column" style="height: 380px;">
                        @if (downtownNews.Count > 0)
                        {
                            <a href="/News/Details/@downtownNews[0].Id" class="text-decoration-none text-white flex-fill d-block mb-1" style="height: 50%;">
                                <div class="card bg-dark text-white position-relative border-0 w-100 h-100">
                                    <img src="@downtownNews[0].ImageUrl" class="card-img rounded shadow-sm"
                                         style="height: 100%; width: 100%; object-fit: cover;" />
                                    <div class="card-img-overlay d-flex align-items-end p-1">
                                        <div style="background: rgba(0, 0, 0, 0.6); width: 100%;" class="px-2 py-1">
                                            <h6 class="card-title mb-0 text-white text-truncate fw-bold">
                                                @downtownNews[0].Title
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                        @if (downtownNews.Count > 1)
                        {
                            <a href="/News/Details/@downtownNews[1].Id" class="text-decoration-none text-white flex-fill d-block mt-1" style="height: 50%;">
                                <div class="card bg-dark text-white position-relative border-0 w-100 h-100">
                                    <img src="@downtownNews[1].ImageUrl" class="card-img rounded shadow-sm"
                                         style="height: 100%; width: 100%; object-fit: cover;" />
                                    <div class="card-img-overlay d-flex align-items-end p-1">
                                        <div style="background: rgba(0, 0, 0, 0.6); width: 100%;" class="px-2 py-1">
                                            <h6 class="card-title mb-0 text-white text-truncate fw-bold">
                                                @downtownNews[1].Title
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                    </div>

                    <!-- العمود الثاني: خبران بنفس الارتفاع -->
                    <div class="col-md-4 d-flex flex-column" style="height: 380px;">
                        @if (downtownNews.Count > 2)
                        {
                            <a href="/News/Details/@downtownNews[2].Id" class="text-decoration-none text-white flex-fill d-block mb-1" style="height: 50%;">
                                <div class="card bg-dark text-white position-relative border-0 w-100 h-100">
                                    <img src="@downtownNews[2].ImageUrl" class="card-img rounded shadow-sm"
                                         style="height: 100%; width: 100%; object-fit: cover;" />
                                    <div class="card-img-overlay d-flex align-items-end p-1">
                                        <div style="background: rgba(0, 0, 0, 0.6); width: 100%;" class="px-2 py-1">
                                            <h6 class="card-title mb-0 text-white text-truncate fw-bold">
                                                @downtownNews[2].Title
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                        @if (downtownNews.Count > 3)
                        {
                            <a href="/News/Details/@downtownNews[3].Id" class="text-decoration-none text-white flex-fill d-block mt-1" style="height: 50%;">
                                <div class="card bg-dark text-white position-relative border-0 w-100 h-100">
                                    <img src="@downtownNews[3].ImageUrl" class="card-img rounded shadow-sm"
                                         style="height: 100%; width: 100%; object-fit: cover;" />
                                    <div class="card-img-overlay d-flex align-items-end p-1">
                                        <div style="background: rgba(0, 0, 0, 0.6); width: 100%;" class="px-2 py-1">
                                            <h6 class="card-title mb-0 text-white text-truncate fw-bold">
                                                @downtownNews[3].Title
                                            </h6>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                    </div>

                    <!-- العمود الثالث: قائمة عامة لا تعتمد على DowntownNews -->
                    <div class="col-md-4">
                        @await Component.InvokeAsync("AllNewsList")
                    </div>
                </div>

                <!-- ✅ خط أحمر فاصل -->
                <div style="height: 3px; background-color: #9b040c; margin: 10px 0;"></div>

                <!-- الشريط الرابع ثلاث أعمدة 4 أخبار لكل عمود — يعتمد على Model.SpecialThreeColumns فقط -->
                <div class="container my-2">
                    @if (Model.SpecialThreeColumns != null && Model.SpecialThreeColumns.Any())
                    {
                        <div class="row">
                            @foreach (var category in Model.SpecialThreeColumns)
                            {
                                <div class="col-md-4 mb-4">
                                    <h2 class="section-title border-bottom pb-2 fw-bold mb-3" style="color: #9b040c;">
                                        <a asp-controller="News" asp-action="ByCategory" asp-route-id="@category.CategoryId"
                                           style="color: inherit; text-decoration: none;">
                                            @category.CategoryName
                                        </a>
                                    </h2>

                                    @if (category.NewsItems != null && category.NewsItems.Count > 0)
                                    {
                                        var firstNews = category.NewsItems.First();
                                        var otherNews = category.NewsItems.Skip(1).Take(3).ToList();

                                        <a href="/News/Details/@firstNews.Id" class="text-decoration-none text-white">
                                            <div class="card bg-dark text-white mb-3 position-relative border-0">
                                                <img src="@firstNews.ImageUrl" class="card-img rounded shadow-sm hover-zoom"
                                                     alt="@firstNews.Title" style="height: 200px; object-fit: cover;">
                                                <div class="card-img-overlay d-flex align-items-end p-0">
                                                    <div style="background: rgba(0, 0, 0, 0.6); width: 100%;" class="p-2">
                                                        <h5 class="card-title mb-0 text-white fw-bold" style="font-size: 1.1rem;">
                                                            @firstNews.Title
                                                        </h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        @foreach (var news in otherNews)
                                        {
                                            <a href="/News/Details/@news.Id" class="text-decoration-none text-dark">
                                                <div class="d-flex mb-2 hover-shadow">
                                                    <img src="@news.ImageUrl"
                                                         style="width: 80px; height: 60px; object-fit: cover;"
                                                         class="rounded me-2" alt="@news.Title">
                                                    <div class="d-flex align-items-center">
                                                        <span class="fw-bold">@news.Title</span>
                                                    </div>
                                                </div>
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted small">لا توجد أقسام خاصة حالياً.</div>
                    }
                </div>
            </section>

            }

            <!-- ✅ خط أحمر فاصل -->
            <div style="height: 3px; background-color: #9b040c; margin: 10px 0;"></div>

            <!-- ✅ قسم بانوراما بثلاثة أعمدة -->
            <section class="my-5">
                @if (panoramaNews != null && panoramaNews.Count >= 8)
                {
                    <h2 class="section-title">
                        <a href="..." style="text-decoration: none; color: inherit;">
                            بانوراما
                        </a>
                    </h2>

                    <div class="row g-3" style="min-height: 400px;">
                        <!-- العمود الأول: خبران -->
                        <div class="col-md-4 d-flex flex-column gap-2">
                            @for (int i = 0; i < 2; i++)
                            {
                                var news = panoramaNews[i];
                                <a href="/News/Details/@news.Id" class="text-decoration-none text-white flex-fill">
                                    <div class="card bg-dark text-white border-0 shadow-sm h-100 position-relative">
                                        <img src="@news.ImageUrl" class="card-img rounded" style="height: 100%; object-fit: cover;" />
                                        <div class="card-img-overlay d-flex align-items-end p-2"
                                             style="background: rgba(0, 0, 0, 0.4); border-radius: 0.5rem;">
                                            <h6 class="card-title text-white fw-bold mb-0">@news.Title</h6>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>

                        <!-- العمود الثاني: خبر رئيسي -->
                        <div class="col-md-4">
                            @if (panoramaNews.Count > 2)
                            {
                                var news = panoramaNews[2];
                                <a href="/News/Details/@news.Id" class="text-decoration-none text-white h-100 d-block">
                                    <div class="card bg-dark text-white border-0 shadow-sm h-100 position-relative">
                                        <img src="@news.ImageUrl" class="card-img rounded" style="height: 100%; object-fit: cover;" />
                                        <div class="card-img-overlay d-flex align-items-end p-3"
                                             style="background: rgba(0, 0, 0, 0.5); border-radius: 0.5rem;">
                                            <h5 class="card-title text-white fw-bold mb-0">@news.Title</h5>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>

                        <!-- العمود الثالث: 5 أخبار مصغّرة -->
                        <div class="col-md-4 d-flex flex-column justify-content-between">
                            @for (int i = 3; i < 8; i++)
                            {
                                var news = panoramaNews[i];
                                <a href="/News/Details/@news.Id" class="text-decoration-none mb-2 hover-shadow">
                                    <div class="d-flex align-items-center p-2 bg-light rounded shadow-sm transition"
                                         style="height: 70px;">
                                        <img src="@news.ImageUrl"
                                             alt="@news.Title"
                                             class="me-2"
                                             style="width: 65px; height: 65px; object-fit: cover; border-radius: 10px;" />
                                        <div class="overflow-hidden">
                                            <div class="fw-bold text-dark text-truncate" style="font-size: 0.9rem;">
                                                @news.Title
                                            </div>
                                            <small class="text-muted">
                                                <i class="far fa-clock me-1"></i>
                                                @news.PublishedDate?.ToString("dd/MM/yyyy")
                                            </small>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }
            </section>

            <!-- قسم المقالات -->
            <section class="my-5 bg-light">
                <h2 class="section-title latest-articles-title">
                    @Localizer["LatestArticles"]
                </h2>

                @if (articleList != null && articleList.Any())
                {
                    <div class="row g-4">
                        @foreach (var article in articleList)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="card h-100 shadow-sm border-0">
                                    @if (!string.IsNullOrEmpty(article.ImageUrl))
                                    {
                                        <img src="@article.ImageUrl" class="card-img-top" alt="@article.Title"
                                             style="height: 180px; object-fit: contain;" />
                                    }
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-primary">@article.Title</h5>
                                        <p class="card-text text-muted mb-2">
                                            @article.Content?.Substring(0, Math.Min(article.Content.Length, 100))...
                                        </p>
                                        <div class="mt-auto">
                                            <small class="text-muted d-block">@Localizer["ByAuthor"]: @article.Author</small>
                                            <small class="text-muted">@article.PublishedDate.ToString("dd MMM yyyy")</small>
                                        </div>
                                    </div>
                                    <a asp-controller="Articles" asp-action="Details" asp-route-id="@article.Id" class="stretched-link"></a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">@Localizer["NoArticlesAvailable"]</p>
                }
            </section>

            <!-- قسم الأخبار حسب التصنيفات -->
            <section class="my-5">
                <h2 class="text-success mb-4 border-bottom pb-2">@Localizer["NewsByCategory"]</h2>

                @if (categoriesWithNews != null && categoriesWithNews.Any())
                {
                    @foreach (var category in categoriesWithNews)
                    {
                        if (category.CategoryId == 1) { continue; }

                        <div class="mb-0">
                            <h3 class="text-secondary">
                                <a asp-controller="News"
                                   asp-action="ByCategory"
                                   asp-route-id="@category.CategoryId"
                                   style="color: #9b040c; text-decoration: none;">
                                    @category.CategoryName
                                </a>
                            </h3>

                            <div class="row">
                                @foreach (var news in category.NewsItems)
                                {
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 shadow-sm border">
                                            @if (!string.IsNullOrEmpty(news.ImageUrl))
                                            {
                                                <a asp-controller="News" asp-action="Details" asp-route-id="@news.Id" class="d-block">
                                                    <img src="@news.ImageUrl"
                                                         class="card-img-top rounded-top"
                                                         alt="@Localizer["NewsImage"]"
                                                         style="height: 180px; object-fit: cover;" />
                                                </a>
                                            }

                                            <div class="card-body">
                                                <h5 class="card-title mb-2">
                                                    <a asp-controller="News" asp-action="Details" asp-route-id="@news.Id"
                                                       class="text-decoration-none text-dark">
                                                        @news.Title
                                                    </a>
                                                </h5>

                                                @{
                                                    var plainText = System.Text.RegularExpressions.Regex.Replace(news.Content ?? "", "<.*?>", "");
                                                    var preview = plainText.Length > 100 ? plainText.Substring(0, 100) + "..." : plainText;
                                                }
                                                <p class="card-text">@preview</p>
                                            </div>

                                            <div class="card-footer bg-white text-muted">
                                                <small>@news.PublishedDate?.ToString("dd/MM/yyyy")</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">@Localizer["NoCategoriesAvailable"]</p>
                }
            </section>
        </div>

        <div class="d-none d-md-block col-md-2"></div>
    </div>
</div>

@section Scripts {
    <!-- لا نفعّل Slick هنا؛ الفلاشلاين يعمل بـ flashline.js فقط -->
    <script src="~/js/components/flashline.js" asp-append-version="true"></script>
    <script>
        // تشغيل التهيئة يدويًا بعد تحميل الصفحة
        window.addEventListener('DOMContentLoaded', function () {
          if (window.FlashLineInitAll) window.FlashLineInitAll();
        });
    </script>
}
